@model manga_reader_web.Models.MangaDetailViewModel
@{
    ViewData["Title"] = Model.Manga?.Title ?? "Chi tiết manga";
}
<!-- Background div riêng biệt -->
<div class="manga-header-background" style="background-image: url('@Model.Manga.CoverUrl')"></div>
<div class="manga-details-container">
    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger mb-4">@ViewBag.ErrorMessage</div>
    }
    
    @if (Model.Manga != null)
    {

        
        <div class="manga-header-container">
            <!-- Row 1: Ảnh bìa và thông tin cơ bản -->
            <div class="manga-header">
                <div class="container py-4">
                    <div class="row">
                        <!-- Column 1: Ảnh bìa -->
                        <div class="col-md-3">
                            <div class="manga-cover-container">
                                <img src="@Model.Manga.CoverUrl" class="manga-cover" alt="@Model.Manga.Title" data-bs-toggle="modal" data-bs-target="#coverModal">
                            </div>
                        </div>
                        <!-- Column 2: Thông tin manga -->
                        <div class="col-md-9 text-white ps-md-0">
                            <!-- Row 2.1: Tên manga, tác giả, họa sĩ -->
                            <div class="manga-info-row manga-info-title">
                                <h1 class="manga-title mb-3">@Model.Manga.Title</h1>
                                
                                <div class="mb-3">
                                    <p><strong><i class="bi bi-person-fill me-2"></i>Tác giả:</strong> @Model.Manga.Author</p>
                                    @if (!string.IsNullOrEmpty(Model.Manga.Artist) && Model.Manga.Artist != Model.Manga.Author)
                                    {
                                        <p><strong><i class="bi bi-brush me-2"></i>Họa sĩ:</strong> @Model.Manga.Artist</p>
                                    }
                                    @if (!string.IsNullOrEmpty(Model.Manga.Publisher))
                                    {
                                        <p><strong><i class="bi bi-building me-2"></i>Nhà xuất bản:</strong> @Model.Manga.Publisher</p>
                                    }
                                </div>
                            </div>
                            
                            <!-- Row 2.2: Các thành phần còn lại -->
                            <div class="manga-info-row manga-info-meta">
                                <div class="d-flex gap-2 mb-3">
                                    @if (Model.Chapters.Any())
                                    {
                                        // Sắp xếp chương theo ngôn ngữ ưu tiên (Việt Nam -> Anh)
                                        var chapters = Model.Chapters.OrderBy(c => c.Number).ToList();
                                        var vietnameseChapters = chapters.Where(c => c.Language == "vi").ToList();
                                        var englishChapters = chapters.Where(c => c.Language == "en").ToList();
                                        
                                        // Ưu tiên tiếng Việt, sau đó đến tiếng Anh, cuối cùng là các ngôn ngữ khác
                                        var firstChapterId = vietnameseChapters.Any() 
                                            ? vietnameseChapters.First().Id 
                                            : englishChapters.Any() 
                                                ? englishChapters.First().Id 
                                                : chapters.First().Id;
                                            
                                        // Tương tự cho chương mới nhất
                                        var newestChapters = Model.Chapters.OrderByDescending(c => double.TryParse(c.Number, out var num) ? num : 0).ToList();
                                        var newestVietnameseChapter = newestChapters.FirstOrDefault(c => c.Language == "vi");
                                        var newestEnglishChapter = newestChapters.FirstOrDefault(c => c.Language == "en");
                                        var newestChapterId = newestVietnameseChapter?.Id ?? newestEnglishChapter?.Id ?? newestChapters.First().Id;
                                        
                                        <a asp-controller="Chapter" asp-action="Read" asp-route-id="@firstChapterId" asp-route-mangaId="@Model.Manga.Id" class="btn btn-primary">
                                            <i class="bi bi-book-fill me-2"></i>Đọc từ đầu
                                        </a>
                                        <a asp-controller="Chapter" asp-action="Read" asp-route-id="@newestChapterId" asp-route-mangaId="@Model.Manga.Id" class="btn btn-success">
                                            <i class="bi bi-lightning-fill me-2"></i>Đọc mới nhất
                                        </a>
                                    }
                                    
                                    <button class="btn btn-outline-light" id="followBtn" data-id="@Model.Manga.Id" data-following="@Model.Manga.IsFollowing.ToString().ToLower()">
                                        @if (Model.Manga.IsFollowing)
                                        {
                                            <i class="bi bi-bookmark-check-fill me-2"></i><span>Đang theo dõi</span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-bookmark-plus me-2"></i><span>Theo dõi</span>
                                        }
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <span class="badge bg-primary me-2">@TranslateStatus(Model.Manga.Status)</span>
                                    @foreach (var tag in Model.Manga.Tags)
                                    {
                                        <span class="badge manga-tag me-2 mb-1">@tag</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 2: Mô tả -->
            @if (!string.IsNullOrEmpty(Model.Manga.Description))
            {
                <div class="manga-description-section">
                    <div class="container py-3">
                        <div class="row">
                            <div class="col-12">
                                <div class="manga-description-container">
                                    <p class="manga-short-description">
                                        @Model.Manga.Description
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Modal hiển thị ảnh -->
        <div class="modal fade" id="coverModal" tabindex="-1" aria-labelledby="coverModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="coverModalLabel">@Model.Manga.Title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="@Model.Manga.CoverUrl" class="img-fluid" alt="@Model.Manga.Title">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container mt-4 mb-5 pb-5">
            <ul class="nav nav-tabs mb-4" id="mangaDetailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="chapters-tab" data-bs-toggle="tab" data-bs-target="#chapters" type="button" role="tab" aria-controls="chapters" aria-selected="true">
                        <i class="bi bi-list-ol me-2"></i>Danh sách chương (@Model.Chapters.Count)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="false">
                        <i class="bi bi-info-circle me-2"></i>Thông tin chi tiết
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="mangaDetailTabsContent">
                <div class="tab-pane fade show active" id="chapters" role="tabpanel" aria-labelledby="chapters-tab">
                    <div class="mb-3">
                        <div class="btn-group" role="group" aria-label="Lọc ngôn ngữ">
                            <input type="radio" class="btn-check" name="language" id="langAll" value="all" checked autocomplete="off">
                            <label class="btn btn-outline-primary" for="langAll">Tất cả</label>
                            
                            <input type="radio" class="btn-check" name="language" id="langVi" value="vi" autocomplete="off">
                            <label class="btn btn-outline-primary" for="langVi">Tiếng Việt</label>
                            
                            <input type="radio" class="btn-check" name="language" id="langEn" value="en" autocomplete="off">
                            <label class="btn btn-outline-primary" for="langEn">Tiếng Anh</label>
                        </div>
                    </div>
                    
                    @{
                        // Nhóm chapters theo ngôn ngữ
                        var chaptersByLanguage = Model.Chapters
                            .GroupBy(c => c.Language)
                            .ToDictionary(g => g.Key, g => g.ToList());
                        
                        // Sắp xếp ngôn ngữ: Tiếng Việt lên đầu, sau đó là tiếng Anh và các ngôn ngữ khác
                        var sortedLanguages = chaptersByLanguage.Keys
                            .OrderBy(lang => lang == "vi" ? 0 : lang == "en" ? 1 : 2)
                            .ThenBy(lang => lang)
                            .ToList();
                    }
                    
                    <div class="chapters-container">
                        <div class="accordion theme-aware-accordion" id="chaptersAccordion">
                            @foreach (var language in sortedLanguages)
                            {
                                var langChapters = chaptersByLanguage[language];
                                var langId = $"lang-{language}";
                                
                                // Tìm chương mới nhất
                                var newestChapter = langChapters.OrderByDescending(c => {
                                    _ = double.TryParse(c.Number, out double num);
                                    return num;
                                }).FirstOrDefault();
                                
                                var newestChapterNumber = newestChapter != null ? newestChapter.Number : "N/A";
                                
                                // Nhóm chapters theo tập (volume) và đảo ngược thứ tự (giảm dần)
                                var chaptersByVolume = langChapters
                                    .GroupBy(c => GetVolumeFromChapterNumber(c.Number))
                                    .OrderByDescending(g => int.TryParse(g.Key, out int volNum) ? volNum : 0)
                                    .ToDictionary(g => g.Key, g => g.OrderByDescending(c => {
                                        _ = double.TryParse(c.Number, out double num);
                                        return num;
                                    }).ToList());
                                
                                <div class="accordion-item chapter-lang-item" data-language="@language">
                                    <h2 class="accordion-header" id="heading-@langId">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@langId" aria-expanded="true" aria-controls="collapse-@langId">
                                            <i class="bi bi-translate me-2"></i>Ngôn ngữ: <span class="fw-bold ms-2">@TranslateLanguage(language)</span>
                                            <span class="badge bg-@(language == "vi" ? "success" : "info") ms-2">@langChapters.Count chương</span>
                                            <span class="badge bg-primary ms-2">Mới nhất: Chương @newestChapterNumber</span>
                                        </button>
                                    </h2>
                                    <div id="collapse-@langId" class="accordion-collapse collapse show" aria-labelledby="heading-@langId" data-bs-parent="#chaptersAccordion">
                                        <div class="accordion-body p-0">
                                            <div class="accordion theme-aware-accordion" id="volumeAccordion-@langId">
                                                @foreach (var volume in chaptersByVolume.Keys)
                                                {
                                                    var volumeChapters = chaptersByVolume[volume];
                                                    var volumeId = $"{langId}-vol-{volume.Replace(".", "-")}";
                                                    
                                                    // Tìm số chương nhỏ nhất và lớn nhất trong volume
                                                    var minChapter = volumeChapters.Last().Number;
                                                    var maxChapter = volumeChapters.First().Number;
                                                    
                                                    <div class="accordion-item">
                                                        <h2 class="accordion-header" id="heading-@volumeId">
                                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@volumeId" aria-expanded="false" aria-controls="collapse-@volumeId">
                                                                <i class="bi bi-journal-bookmark me-2"></i>Tập @volume
                                                                <span class="badge bg-secondary ms-2">Chương @minChapter - @maxChapter</span>
                                                            </button>
                                                        </h2>
                                                        <div id="collapse-@volumeId" class="accordion-collapse collapse" aria-labelledby="heading-@volumeId" data-bs-parent="#volumeAccordion-@langId">
                                                            <div class="accordion-body p-0">
                                                                <div class="list-group list-group-flush theme-aware-list">
                                                                    @foreach (var chapter in volumeChapters)
                                                                    {
                                                                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                                                                            <div>
                                                                                <h6 class="mb-0">@chapter.Title</h6>
                                                                                <small class="text-muted">@chapter.PublishedAt.ToString("dd/MM/yyyy")</small>
                                                                            </div>
                                                                            <a asp-controller="Chapter" asp-action="Read" 
                                                                               asp-route-id="@chapter.Id" 
                                                                               asp-route-mangaId="@Model.Manga.Id"
                                                                               class="btn btn-sm btn-primary">
                                                                                <i class="bi bi-book"></i> Đọc
                                                                            </a>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="info" role="tabpanel" aria-labelledby="info-tab">
                    <div class="card manga-details-card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Mô tả đầy đủ</h5>
                            <p class="card-text manga-description">@Model.Manga.Description</p>
                            
                            <h5 class="card-title mt-4 mb-3">Thông tin chi tiết</h5>
                            <ul class="list-group list-group-flush theme-aware-list">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-person-fill me-2"></i>Tác giả</span>
                                    <span>@Model.Manga.Author</span>
                                </li>
                                @if (!string.IsNullOrEmpty(Model.Manga.Artist) && Model.Manga.Artist != Model.Manga.Author)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-brush me-2"></i>Họa sĩ</span>
                                        <span>@Model.Manga.Artist</span>
                                    </li>
                                }
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-flag-fill me-2"></i>Trạng thái</span>
                                    <span class="badge bg-primary">@TranslateStatus(Model.Manga.Status)</span>
                                </li>
                                @if (!string.IsNullOrEmpty(Model.Manga.OriginalLanguage))
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-globe me-2"></i>Ngôn ngữ gốc</span>
                                        <span>@TranslateLanguage(Model.Manga.OriginalLanguage)</span>
                                    </li>
                                }
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-translate me-2"></i>Bản dịch có sẵn</span>
                                    <span>
                                        @{
                                            var languages = Model.Chapters.Select(c => c.Language).Distinct().ToList();
                                            foreach (var lang in languages)
                                            {
                                                <span class="badge bg-@(lang == "vi" ? "success" : "info") me-1">@TranslateLanguage(lang)</span>
                                            }
                                        }
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-list-ol me-2"></i>Số chương</span>
                                    <span>@Model.Chapters.Count</span>
                                </li>
                                @if (!string.IsNullOrEmpty(Model.Manga.PublicationDemographic))
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-people-fill me-2"></i>Đối tượng</span>
                                        <span>@TranslateDemographic(Model.Manga.PublicationDemographic)</span>
                                    </li>
                                }
                                @if (!string.IsNullOrEmpty(Model.Manga.ContentRating))
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-shield-fill me-2"></i>Xếp hạng nội dung</span>
                                        <span>@TranslateContentRating(Model.Manga.ContentRating)</span>
                                    </li>
                                }
                                @if (Model.Manga.LastUpdated.HasValue)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-clock-fill me-2"></i>Cập nhật lần cuối</span>
                                        <span>@Model.Manga.LastUpdated.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                    </li>
                                }
                            </ul>
                            
                            <h5 class="card-title mt-4 mb-3">Thể loại</h5>
                            <div class="manga-tags">
                                @foreach (var tag in Model.Manga.Tags)
                                {
                                    <span class="badge manga-tag me-2 mb-2">@tag</span>
                                }
                            </div>
                            
                            @if (!string.IsNullOrEmpty(Model.Manga.AlternativeTitles))
                            {
                                <h5 class="card-title mt-4 mb-3">Tên khác</h5>
                                <p class="card-text manga-alt-titles">@Model.Manga.AlternativeTitles</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="container">
            <div class="text-center py-5">
                <i class="bi bi-emoji-frown display-1 text-muted"></i>
                <h3 class="mt-3">Không tìm thấy thông tin manga</h3>
                <p class="text-muted">Manga bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
                <a asp-controller="Home" asp-action="Index" class="btn btn-primary mt-3" hx-get="@Url.Action("Index", "Home")" hx-target="#main-content" hx-push-url="true">
                    <i class="bi bi-house-door me-2"></i>Quay lại trang chủ
                </a>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="~/js/manga-details.js" asp-append-version="true"></script>
}

@functions {
    public string TranslateStatus(string status)
    {
        return status switch
        {
            "ongoing" => "Đang tiến hành",
            "completed" => "Hoàn thành",
            "hiatus" => "Tạm ngưng",
            "cancelled" => "Đã hủy",
            _ => "Không rõ"
        };
    }
    
    public string TranslateLanguage(string lang)
    {
        return lang switch
        {
            "vi" => "Tiếng Việt",
            "en" => "Tiếng Anh",
            "ja" => "Tiếng Nhật",
            "zh" => "Tiếng Trung",
            "ko" => "Tiếng Hàn",
            "fr" => "Tiếng Pháp",
            "es" => "Tiếng Tây Ban Nha",
            "de" => "Tiếng Đức",
            "it" => "Tiếng Ý",
            "ru" => "Tiếng Nga",
            "pt-br" => "Tiếng Bồ Đào Nha (Brazil)",
            "id" => "Tiếng Indonesia",
            "th" => "Tiếng Thái",
            _ => lang?.ToUpper() ?? "Không rõ"
        };
    }
    
    public string TranslateDemographic(string demographic)
    {
        return demographic switch
        {
            "shounen" => "Shounen (Nam thiếu niên)",
            "shoujo" => "Shoujo (Nữ thiếu niên)",
            "seinen" => "Seinen (Nam thanh niên)",
            "josei" => "Josei (Nữ thanh niên)",
            _ => demographic
        };
    }
    
    public string TranslateContentRating(string rating)
    {
        return rating switch
        {
            "safe" => "An toàn",
            "suggestive" => "Gợi cảm",
            "erotica" => "Khiêu dâm",
            "pornographic" => "Người lớn",
            _ => rating
        };
    }
    
    // Tách volume từ số chapter, ví dụ: "12.5" -> "12"
    public string GetVolumeFromChapterNumber(string chapterNumber)
    {
        // Nếu không thể parse số chapter, trả về "Không xác định"
        if (string.IsNullOrEmpty(chapterNumber) || !double.TryParse(chapterNumber, out double number))
        {
            return "Không xác định";
        }
        
        // Ví dụ: Chapter 1-10 thuộc tập 1, Chapter 11-20 thuộc tập 2, v.v.
        int volume = (int)(Math.Floor(number) / 10) + 1;
        return volume.ToString();
    }
} 